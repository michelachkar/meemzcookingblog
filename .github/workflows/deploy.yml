name: Deploy to Production

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v2
        with:
          fetch-depth: 0  # Pour s'assurer que nous avons l'historique complet des commits (utile pour certaines actions)
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2
        with:
          version: latest
        continue-on-error: false
        id: setup_buildx

      - name: Log in to AWS ECR
        uses: aws-actions/amazon-ecr-login@v1
        id: ecr_login
        continue-on-error: false

      - name: Build Docker image
        run: |
          echo "---------------------------------------------"
          echo "Starting Docker build..."
          echo "---------------------------------------------"
          docker build -f prod/Dockerfile.prod -t my-site-prod .
          echo "---------------------------------------------"
          echo "Docker build completed."
          echo "---------------------------------------------"
          
          echo "---------------------------------------------"
          echo "Tagging the image..."
          echo "---------------------------------------------"
          docker tag my-site-prod:latest ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ secrets.AWS_REGION_NAME }}.amazonaws.com/my-site-prod:latest
          echo "---------------------------------------------"
          echo "Image tagged."
          echo "---------------------------------------------"

          echo "---------------------------------------------"
          echo "Pushing image to AWS ECR..."
          echo "---------------------------------------------"
          docker push ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ secrets.AWS_REGION_NAME }}.amazonaws.com/my-site-prod:latest
          echo "---------------------------------------------"
          echo "Image pushed to ECR."
          echo "---------------------------------------------"

      - name: Set up Docker Compose
        run: |
          echo "---------------------------------------------"
          echo "Starting Docker Compose build..."
          echo "---------------------------------------------"
          docker-compose -f prod/docker-compose.yml.prod build
          echo "---------------------------------------------"
          echo "Docker Compose build completed."
          echo "---------------------------------------------"

          echo "---------------------------------------------"
          echo "Pushing images with Docker Compose..."
          echo "---------------------------------------------"
          docker-compose -f prod/docker-compose.yml.prod push
          echo "---------------------------------------------"
          echo "Docker Compose push completed."
          echo "---------------------------------------------"

      - name: SSH into EC2 and run docker-compose
        run: |
          echo "---------------------------------------------"
          echo "SSHing into EC2 instance..."
          echo "---------------------------------------------"
          ssh -i ${{ secrets.EC2_PRIVATE_KEY }} ubuntu@${{ secrets.EC2_HOST }} << 'EOF'
            
            echo "---------------------------------------------"
            echo "Changing to project directory..."
            echo "---------------------------------------------"
            cd /path/to/your/project

            echo "---------------------------------------------"
            echo "Running docker-compose up..."
            echo "---------------------------------------------"
            docker-compose -f prod/docker-compose.yml.prod up -d

            echo "---------------------------------------------"
            echo "Docker Compose containers are now up."
            echo "---------------------------------------------"
          EOF
